# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: arch/arm/configs/mustang_defconfig

pkgname=linux-amazon-mustang64
pkgver=4.9.117
pkgrel=1
pkgdesc="Amazon Fire 7 (2019) 64bit kernel fork"
arch="aarch64"
_carch="arm64"
_flavor="amazon-mustang64"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="bash bc bison devicepkg-dev flex openssl-dev perl gcc6"

# Compiler: GCC 6 (doesn't boot when compiled with newer versions)
if [ "${CC:0:5}" != "gcc6-" ]; then
	CC="gcc6-$CC"
	HOSTCC="gcc6-gcc"
	CROSS_COMPILE="gcc6-$CROSS_COMPILE"
fi

# Source
_repository="linux-amazon-mediatek-mt8163-kernel-source"
_commit="Fire_7_9th_Gen-7.3.2.1-20210725"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/hexdump0815/$_repository/archive/$_commit.tar.gz
	$_config
	pinctrl-mtk-common.patch
	linux4.2-gcc10-extern_YYLOC_global_declaration.patch
"
builddir="$srcdir/$_repository-$_commit"
_outdir="out"

prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor" "$_outdir"

	# in case there will be modules at any time, make sure they get installed as well
	unset LDFLAGS
	make O="$_outdir" ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS" \
		INSTALL_MOD_PATH="$pkgdir" INSTALL_MOD_STRIP=1 modules_install
}

sha512sums="
6b6f6d429b5214e0bdf80ffa6cf9f69d8761f5a0f84b4d166bd2be62b8dfed1e08ce1b03e5e836895cc139cd36bd7abf861cd57fdce2c9ce998ab75bdd6c6bdf  linux-amazon-mustang64-Fire_7_9th_Gen-7.3.2.1-20210725.tar.gz
cf3e6edf5cc7a859b5866d68cc7335d7e0e0a576ba755db9738c76ce9a19f8c6ce2630f93b30358c1aef4110ffef634e2703eed793457e64e6ee4eead3e5f371  config-amazon-mustang64.aarch64
f1ce4270766e992bc2c03821cf2e62c60d987adb7f448d5ae7430f6eba4d0d6718f337c9f0d7e4db4097f5f49d5b49e653fcb6a1ee50fa8d07b625bb04a87484  pinctrl-mtk-common.patch
eaf2e61fcb508cdd239b8fed209d2a09ecac77287f6b46d003918fdf1c6fa2ee63f7390f3ff7c49029b8ed6cbcdd81c7e9a4b1ece9f5060b6fc84e322bd47f41  linux4.2-gcc10-extern_YYLOC_global_declaration.patch
"
