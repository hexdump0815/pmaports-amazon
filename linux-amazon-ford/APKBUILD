# Reference: <https://postmarketos.org/vendorkernel>
# Kernel config based on: https://github.com/NixOS/mobile-nixos/blob/master/devices/amazon-austin/kernel/config.armv7

pkgname=linux-amazon-ford
pkgver=3.10.54
pkgrel=3
pkgdesc="Amazon Fire 7 (2015) kernel"
arch="armv7"
_carch="arm"
_flavor="amazon-ford"
url="https://kernel.org"
license="GPL-2.0-only"
options="!strip !check !tracedeps pmb:cross-native"
makedepends="perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev devicepkg-dev gcc4 xz"

# Compiler: GCC 4 (doesn't compile with versions above GCC 4)
if [ "${CC:0:5}" != "gcc4-" ]; then
	CC="gcc4-$CC"
	HOSTCC="gcc4-gcc"
	CROSS_COMPILE="gcc4-$CROSS_COMPILE"
fi

# Source from amazon stock kernel
_repository="linux-amazon-mediatek-mt8127-kernel-source"
_commit="def3ccfb02e9715ad86a2e26c09ee216ba73b256"
_config="config-$_flavor.$arch"
source="
	$pkgname-$_commit.tar.gz::https://github.com/hexdump0815/$_repository/archive/$_commit.tar.gz
	$_config
"
builddir="$srcdir/$_repository-$_commit"

prepare() {
	default_prepare
	. downstreamkernel_prepare
}

build() {
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS"
}

package() {
	downstreamkernel_package "$builddir" "$pkgdir" "$_carch" "$_flavor"
}

sha512sums="
a93cb29e3a90627254bcea5eb3f54bb5cebcb31737a409886e0412eba03c0f42bc5c9bc188e7de8b034859cadae008f1cf381980c97854a605995a1a625b918a  linux-amazon-ford-def3ccfb02e9715ad86a2e26c09ee216ba73b256.tar.gz
97d1c02ef2545b9561b6652c03dd699331b1aa74a6537f3fbf0c78aae587c4eecab6673ce36008ac336cf7995199ce0dc32f59f1686d8001c0292e3881877ecd  config-amazon-ford.armv7
"
